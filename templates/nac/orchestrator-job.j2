apiVersion: batch/v1
kind: Job
metadata:
  name: nac-orchestrator
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      serviceAccountName: nac-installer-sa
      containers:
      - name: orchestrator
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "-c"]
        args:
        - |
          set -e
          echo "=== Starting NAC Orchestration ==="
          NETWORK_PREFIX="{{ network_prefix }}"
          SITE_NAME="{{ site_name }}"

          get_pod() {
            kubectl get pod -l app=$1 -o jsonpath="{.items[0].metadata.name}"
          }

          run_on() {
            local node=$1
            local cmd=$2
            local pod=$(get_pod $node)
            echo "[$node] Executing: $cmd"
            kubectl exec $pod -- /bin/bash -c "$cmd"
          }

          copy_from_pod() {
            local node=$1
            local src=$2
            local dest=$3
            local pod=$(get_pod $node)
            echo "[$node] Copying FROM: $src -> Local: $dest"
            kubectl exec $pod -- cat $src > $dest
          }

          copy_to_pod() {
            local node=$1
            local src=$2
            local dest=$3
            local pod=$(get_pod $node)
            echo "[$node] Copying TO: $dest <- Local: $src"
            kubectl exec $pod -- mkdir -p $(dirname $dest)
            cat $src | kubectl exec -i $pod -- /bin/bash -c "cat > $dest"
          }

          setup_node_env() {
            local node=$1
            local pod=$(get_pod $node)
            echo "Setting up environment for $node..."

            kubectl exec $pod -- mkdir -p /root/nac /data/nac-data
            for file_path in /src-mount/*; do
                filename=$(basename "$file_path")
                if [ "$filename" == "*" ]; then continue; fi
                copy_to_pod $node "$file_path" "/root/nac/$filename"
            done
            kubectl exec $pod -- /bin/bash -c "cd /root/nac && make -j2"
          }

          echo ">>> Phase 1: Deploying Source Codes & Compiling..."
          ALL_NODES=({% for node in nodes %}"{{ node.name }}" {% endfor %})

          for node in "${ALL_NODES[@]}"; do
            setup_node_env $node
          done


          echo ">>> Phase 2: Generating Keys & Policies..."
          {% for policy in policies %}
          AM_NODE="{{ policy.am_node }}"
          AM_ID_NAME="$NETWORK_PREFIX/$SITE_NAME/$AM_NODE"

          run_on $AM_NODE "mkdir -p /data/nac-data"

          echo "    Ensuring Identity $AM_ID_NAME exists on $AM_NODE..."
          run_on $AM_NODE "ndnsec key-gen -t r $AM_ID_NAME | ndnsec cert-install -"

          echo "--- Configuring Policy managed by AM: $AM_NODE ---"
          {% for content in policy.data_contents %}
          CONTENT_PREFIX="{{ content.prefix }}"
          #PrefixからMD5ハッシュ(先頭8文字)を生成
          PREFIX_HASH=$(echo -n "$CONTENT_PREFIX" | md5sum | awk '{print $1}' | cut -c1-8)
          KEK_FILE="kek_${PREFIX_HASH}.data"
          echo "  > Target Content: $CONTENT_PREFIX (Hash: $PREFIX_HASH)"

          echo "    Generating KEK -> $KEK_FILE"
          run_on $AM_NODE "ndn-nac dump-kek -i $AM_ID_NAME -d $CONTENT_PREFIX > /data/nac-data/$KEK_FILE"

          {% for consumer in content.allowed_consumers %}
          CONS_NODE="{{ consumer }}"
          CONS_ID_NAME="$NETWORK_PREFIX/$SITE_NAME/$CONS_NODE"

          KDK_FILE="kdk_${PREFIX_HASH}_${CONS_NODE}.data"
          echo "    >> Processing Consumer: $CONS_NODE"

          run_on $CONS_NODE "mkdir -p /root/nac /data/nac-data"

          run_on $CONS_NODE "ndnsec key-gen -t r $CONS_ID_NAME | ndnsec cert-install -"
          run_on $CONS_NODE "ndnsec cert-dump -i $CONS_ID_NAME > /root/nac/my_cert.data"

          copy_from_pod $CONS_NODE /root/nac/my_cert.data /tmp/${CONS_NODE}.cert
          copy_to_pod $AM_NODE /tmp/${CONS_NODE}.cert /root/nac/${CONS_NODE}.cert

          echo "       Generating KDK (add-member)..."
          run_on $AM_NODE "ndn-nac add-member -i $AM_ID_NAME -d $CONTENT_PREFIX -m /root/nac/${CONS_NODE}.cert -o /root/nac/$KDK_FILE"
          run_on $AM_NODE "cp /root/nac/$KDK_FILE /data/nac-data/"

          {% endfor %} # End Consumers
          {% endfor %} # End Data Contents
          {% endfor %} # End Policies

          #echo ">>> Phase 3: Launching Applications..."

          #{% for policy in policies %}
          #AM_NODE="{{ policy.am_node }}"
          #echo "Starting KDK Server on $AM_NODE"
          #run_on $AM_NODE "nohup /root/nac/kdk-server > /root/nac/kdk-server.log 2>&1 &"

          #{% for content in policy.data_contents %}
          #CONTENT_PREFIX="{{ content.prefix }}"

          # Producer (AMノード)
          #echo "Starting Producer on $AM_NODE for $CONTENT_PREFIX"
          #run_on $AM_NODE "export NDN_DATA_PREFIX=$CONTENT_PREFIX; nohup /root/nac/producer > /root/nac/producer.log 2>&1 &"

          #{% for consumer in content.allowed_consumers %}
          #CONS_NODE="{{ consumer }}"
          #echo "Starting Consumer on $CONS_NODE for $CONTENT_PREFIX"
          #run_on $CONS_NODE "export NDN_DATA_PREFIX=$CONTENT_PREFIX; nohup /root/nac/consumer > /root/nac/consumer.log 2>&1 &"
          #{% endfor %}

          {% endfor %}
          {% endfor %}

          echo "=== NAC Orchestration Complete ==="
          exit 0

        volumeMounts:
        - name: src-vol
          mountPath: /src-mount
      volumes:
      - name: src-vol
        configMap:
          name: nac-source-code

      restartPolicy: Never


